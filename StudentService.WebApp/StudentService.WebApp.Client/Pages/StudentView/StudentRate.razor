@page "/student/{studentId}/rate"
@inject HttpClient _http

<MudContainer>
    <MudText Typo="Typo.h4" Align="Align.Center" Class="mt-10 mb-6">Ocijeni završene poslove</MudText>
    @if (applications == null)
    {
        <MudText>Učitavanje...</MudText>
    }
    else if (!applications.Any())
    {
        <MudText>Nema završenih poslova za ocijeniti.</MudText>
    }
    else
    {
        <MudGrid>
            @foreach (var app in applications)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard>
                        <MudCardContent>
                            <MudText Typo="Typo.h6">@app.JobBasicInfo?.Title</MudText>
                            <MudText Typo="Typo.body2">@app.JobBasicInfo?.PlaceOfWork</MudText>
                            <MudText Typo="Typo.caption">@app.JobBasicInfo?.StartDate.ToString("dd.MM.yyyy") - @app.JobBasicInfo?.EndDate.ToString("dd.MM.yyyy")</MudText>
                            <MudIconButton Icon="@Icons.Material.Filled.ThumbUp" Color="Color.Success" OnClick="() => Rate(app.JobBasicInfo.Id, true, app.ApplicationId)" />
                            <MudIconButton Icon="@Icons.Material.Filled.ThumbDown" Color="Color.Error" OnClick="() => Rate(app.JobBasicInfo.Id, false, app.ApplicationId)" />
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

@code {
    [Parameter] 
    public string studentId { get; set; }

    private IEnumerable<ApplicationInfo>? applications;

    protected override async Task OnInitializedAsync()
    {
        applications = await _http.GetFromJsonAsync<IEnumerable<ApplicationInfo>>($"Applications/finished/{studentId}/student");
    }

    private async Task Rate(string jobId, bool isPositive, string applicationId)
    {
        var resp = await _http.PutAsJsonAsync($"Jobs/{jobId}/rating/company?studentId={studentId}&isPositiveRating={isPositive}", new { });
        if (resp.IsSuccessStatusCode)
        {
            applications = await _http.GetFromJsonAsync<IEnumerable<ApplicationInfo>>($"Applications/finished/{studentId}/student");
            StateHasChanged();
        }
    }
}
